# 加锁策略
前提：mysql版本5.x系列 <=5.7.24，8.0系列<=8.0.13   
加锁规则，两个原则两个优化一个bug：    
原则1:加锁的基本单位是next-key lock，前开后闭区间    
原则2:查找过程中访问到的对象才会加锁,如果是普通索引，找到目标数据后不能马上停下来，需要继续向右找到第一个不满足条件的值      
优化1:索引上的等值查询，给唯一索引加锁的时候，next-key lock退化为行锁   
优化2:索引上的等值查询，向右遍历时且最后一个值不满足等值条件的时候，next-key lock退化为间隙锁   
一个bug：唯一索引上的范围查询会访问到不满足条件的第一个值为止。   
# 加锁的两阶段
next-key lock在分析问题的时候可以直接使用，但是在实际的加锁过程中实际是分为两步的，即先进行间隙锁的加锁，然后在进行行锁的加锁  
# 表创建
```sql
CREATE TABLE `t` (
  `id` int(11) NOT NULL,
  `c` int(11) DEFAULT NULL,
  `d` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `c` (`c`)
) ENGINE=InnoDB;
 
insert into t values(0,0,0),(5,5,5),
(10,10,10),(15,15,15),(20,20,20),(25,25,25);
```
id   c    d 
0    0    0
5    5    5
10   10   10
15   15   15
20   20   20
25   25   25
30   10   30

(10,15] (15,20] (20,25]